<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="/css/main-page.css">
    <script src="/js/main-page.js"></script>
    <script src="/js/nav-bar-search.js"></script>

    <script>
        function editReview(button) {
            var form = document.getElementById('edit-review-form');
            form.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('edit-review-form').addEventListener('submit', function (event) {
                event.preventDefault();

                var formData = new FormData(event.target);
                var title = formData.get('title');
                var comment = formData.get('comment');
                var recommendation = formData.get('recommendation');

                // Find the closest parent element with the data-review-id attribute
                var reviewContainer = this.closest('.col-md-4');
                var reviewId = reviewContainer.dataset.reviewId;

                // Check if reviewId is a valid ObjectId
                if (!isValidObjectId(reviewId)) {
                    console.error('Invalid reviewId:', reviewId);
                    return;
                }

                fetch('/update-review/' + reviewId, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: title,
                        comment: comment,
                        recommendation: recommendation
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Handle the response as needed
                        console.log('Update successful:', data);

                        // Update the review content in the DOM
                        reviewContainer.querySelector('h5').innerText = title;
                        reviewContainer.querySelector('p').innerText = comment;
                        reviewContainer.querySelector('#recommendation').innerText = 'Thoughts: ' + recommendation;

                        // Optionally, you can hide the edit form
                        this.style.display = 'none';
                    })
                    .catch(error => {
                        // Handle errors
                        console.error('Error updating review:', error);
                    });
            });
        });



        // Function to check if a string is a valid ObjectId
        function isValidObjectId(id) {
            return /^[a-f\d]{24}$/i.test(id);
        }

        function deleteReview(button) {
            var reviewId = button.closest('.col-md-4').dataset.reviewId;

            // Check if reviewId is a valid ObjectId
            if (!isValidObjectId(reviewId)) {
                console.error('Invalid reviewId:', reviewId);
                return;
            }

            fetch('/delete-review/' + reviewId, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
                .then(response => response.json())
                .then(data => {
                    // Handle the response as needed
                    console.log('Delete successful:', data);
                    // Optionally, you can remove the deleted review from the UI
                    button.closest('.col-md-4').remove();
                })
                .catch(error => {
                    // Handle errors
                    console.error('Error deleting review:', error);
                });
        }

        // Function to mark a review as helpful
function markHelpful(reviewId) {
    markReview(reviewId, 'helpful');
}

// Function to mark a review as unhelpful
function markUnhelpful(reviewId) {
    markReview(reviewId, 'unhelpful');
}

// Function to handle marking a review
function markReview(reviewId, action) {
    // Check if reviewId is a valid ObjectId
    if (!isValidObjectId(reviewId)) {
        console.error('Invalid reviewId:', reviewId);
        return;
    }

    // Fetch URL for marking helpful or unhelpful based on the 'action' parameter
    const url = action === 'helpful' ? '/mark-helpful/' : '/mark-unhelpful/';

    fetch(url + reviewId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
    })
        .then(response => response.json())
        .then(data => {
            // Handle the response as needed
            console.log(action + ' mark successful:', data);

            // Update the helpful or unhelpful count in the DOM
            const reviewContainer = document.getElementById(reviewId);
            if (action === 'helpful') {
                reviewContainer.querySelector('.count p:nth-child(1)').innerText = 'Helpful: ' + data.helpfulCount;
            } else {
                reviewContainer.querySelector('.count p:nth-child(2)').innerText = 'Unhelpful: ' + data.unhelpfulCount;
            }
        })
        .catch(error => {
            // Handle errors
            console.error('Error marking review as ' + action + ':', error);
        });
}


    </script>
</head>

<body>
    <div class="col-md-4" id="{{review._id}}" data-review-id="{{review._id}}">
        <div class="card">
            <div class="card-body">
                <div class="user-info">
                    <a href="user-profile.html">
                        <img src="{{review.usericon}}">
                        <span class="username">@{{review.username}}</span>
                    </a>
                </div>
                <div>
                    <h5>{{review.title}}</h5>
                    <p>{{review.comment}}</p>
                    <p><span id="recommendation">Thoughts: {{review.recommendation}}</span></p>
                    <div class="review-buttons">
                        {{#if_eq loggedInUser.username review.username}}
                        <button class="edit" onclick="editReview(this)">Edit</button>
                        <button class="delete" onclick="deleteReview(this)">Delete</button>
                        {{else}}
                        <button class="mark-helpful" onclick="markHelpful('{{review._id}}')">Mark Helpful</button>
                        <button class="mark-unhelpful" onclick="markUnhelpful('{{review._id}}')">Mark Unhelpful</button>

                        {{/if_eq}}
                    </div>
                    <div class="count">
                        <p>Helpful: {{review.helpfulCount}}</p>
                        <p>Unhelpful: {{review.unhelpfulCount}}</p>
                    </div>

                    <form id="edit-review-form" style="display: none;" action="/update-review/{{review._id}}"
                        method="PUT">
                        <!-- Add the hidden field for method override -->
                        <input type="hidden" name="_method" value="PUT">
                        <input type="hidden" name="restaurantId" value="{{review.restaurantId}}">

                        <label for="title">Title:</label><br>
                        <input type="text" id="title" name="title" value="{{review.title}}"><br>
                        <label for="comment">Comment:</label><br>
                        <textarea id="comment" name="comment">{{review.comment}}</textarea><br>
                        <label for="recommendation">Recommendation:</label><br>
                        <select id="recommendation" name="recommendation">
                            <option value="Recommended" {{#if_eq review.recommendation "Recommended"
                                }}selected{{/if_eq}}>Recommended</option>
                            <option value="Not Recommended" {{#if_eq review.recommendation "Not Recommended"
                                }}selected{{/if_eq}}>Not Recommended</option>
                        </select><br>
                        <input type="submit" value="Submit">
                    </form>


                    <div class="comment-box">
                        <textarea id="text-input" placeholder="comment..."></textarea>
                    </div>
                </div>

            </div>
        </div>
    </div>
</body>

</html>